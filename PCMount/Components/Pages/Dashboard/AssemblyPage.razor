@page "/dashboard/assembly/{Id:int}"
@attribute [Authorize(Roles = "Admin")]
@layout DashboardLayout
@rendermode InteractiveServer
<PageTitle>PCMount - Assembly</PageTitle>

@inject OrdersService OrdersDb
@inject ComponentesService ComponentesDb
@inject InventarioService InventarioDb
@inject NavigationManager Navigation

@if (Id <= 0) {
    <span class="text-center text-xl text-gray-200 mt-8">Invalid Assembly ID.</span>
} else {
    if (order == null || steps == null) {
        <span class="text-center text-xl text-gray-200 mt-8">No order found with the ID @Id to be assembled.</span>
    } else {
        @if (order.Status == OrderStatus.Done) {
            <span class="text-center text-xl text-gray-200 mt-8">Order ID @Id has already been assembled.</span>
        } else {
            <div class="relative w-full h-screen-space -mt-4">
                <FluentBadge Appearance="Appearance.Accent" Class="text-md md:text-xl p-2"><span class="flex flex-row justify-center items-center gap-1"><FluentIcon Color="Color.Fill" Value="@(new Icons.Regular.Size20.Wrench())" />You're Assemblying An <b>@order?.Name</b> For Order Id:<b>@Id</b></span></FluentBadge>
                <FluentWizard @ref="wizardInstance" Class="min-h-full" StepperPosition="StepperPosition.Left" StepSequence="WizardStepSequence.Any" DisplayStepNumber="@(WizardStepStatus.Current | WizardStepStatus.Next)" StepTitleHiddenWhen="@GridItemHidden.XsAndDown" OnFinish="@OnFinishedAsync">
                    <Steps>
                        <FluentWizardStep Label="Overview" OnChange="@OnStepChange">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 p-4">
                                <ColorImage imageUrl="@imageUrl" Class="w-full h-step-screen" />
                                <div class="flex flex-col justify-center items-center relative">
                                    <div class="flex flex-col gap-4 p-4">
                                        <h3 class="text-xl">Estimated Total Assembly Time</h3>
                                        <FluentBadge Class="text-2xl font-medium">
                                            <span class="flex flex-row justify-center items-center gap-1">
                                                <FluentIcon Value="@(new Icons.Regular.Size20.Clock())" />
                                                <span>@calculateTotalETA() minutes</span>
                                            </span>
                                        </FluentBadge>
                                    </div>
                                    <div class="flex flex-col justify-center items-center p-4">
                                        <h3 class="text-xl">Assembly Steps</h3>
                                        <div class="grid grid-cols-4 gap-3 p-4">
                                            @foreach (var step in steps!) {
                                                <FluentCard MinimalStyle="true" Class="p-4 flex justify-center items-center relative cursor-pointer" @onmouseover="@(e => hoveringItem(step.StepNumber))" @onclick="() => jumpToStep(step.StepNumber)">
                                                    @if (IsStepCompleted(step.StepNumber)) {
                                                        <FluentIcon Value="@(new Icons.Regular.Size20.Checkmark())" />
                                                    }
                                                    <FluentBadge Appearance="Appearance.Lightweight"><span class="text-lg font-bold">@step.Name</span></FluentBadge>
                                                </FluentCard>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </FluentWizardStep>
                        @foreach (var step in steps!) {
                            <FluentWizardStep Label="@step.Label" OnChange="@OnStepChange">
                                <AssemblyStep OnComplete="@stepDone" OnUncomplete="@stepUnDone" OnStepNumberChanged="@stepStarted" StepNumber="@step.StepNumber" PartsList="@step.AvaliableParts" PartToAssemble="@step.PartToAssemble" />
                            </FluentWizardStep>
                        }
                        <FluentWizardStep Label="Finalize" Disabled=@(!Finalize) OnChange="@OnStepChange">
                            <div class="flex flex-row justify-center items-center gap-4 p-8">
                                <div class="w-4/5 flex flex-col justify-center items-center relative">
                                <div class="flex">
                                    <div class="flex flex-col w-1/2 gap-2 justify-center">
                                        @if (partsWithQuantities != null) {
                                            @foreach (var (part, quantity) in partsWithQuantities) {
                                                <p class="text-lg">@part.Tipo: <FluentBadge class="text-lg font-medium">@part.Name</FluentBadge> ✔️</p>
                                            }
                                        }
                                    </div>
                                    <img class="w-1/2" src=@order?.Image alt="Final Order Image">
                                </div>
                                    <FluentButton IconStart="@(new Icons.Regular.Size24.Box())" Appearance="Appearance.Accent" @onclick="() => OrderDone()" class="text-2xl font-light mt-8">
                                        MARK ORDER ID: <span class="font-medium">@order?.OrderId</span> AS DONE
                                    </FluentButton>
                                </div>
                            </div>
                        </FluentWizardStep>
                    </Steps>
                </FluentWizard>
            </div>
        }
    }
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Order? order;
    private List<(Part Part, int Quantity)>? partsWithQuantities;
    private bool Finalize = false;
    public class Steps {
        public int StepNumber {get; set; }
        public string? Name { get; set; }
        public string? Label { get; set; }
        public bool IsCompleted { get; set; }
        public List<Part>? AvaliableParts { get; set; }
        public Part? PartToAssemble { get; set; }
        public int ETA { get; set; }
    }

    private List<Steps>? steps;

    protected override async Task OnParametersSetAsync() {
        if (Id <= 0) { // Invalid ID
            order = null;
            return;
        } else {
            order = await OrdersDb.FindOneAsync(o => o.OrderId == Id); // Fetch the order using FindOneAsync
            if (order != null) {
                partsWithQuantities = await OrdersDb.GetPartsForOrderAsync(order);
                steps = new List<Steps> {
                    new Steps { StepNumber = 0, Name = "Case", Label = "Prepare Case", IsCompleted = false, AvaliableParts = (await ComponentesDb.GetPartsByTypeAsync(PartTipo.Case)), PartToAssemble = getPartByType(PartTipo.Case), ETA = 2 },
                    new Steps { StepNumber = 1, Name = "Power Supply", Label = "Install PSU", IsCompleted = false, AvaliableParts = (await ComponentesDb.GetPartsByTypeAsync(PartTipo.PowerSupply)), PartToAssemble = getPartByType(PartTipo.PowerSupply), ETA = 3 },
                    new Steps { StepNumber = 2, Name = "Motherboard", Label = "Install Motherboard", IsCompleted = false, AvaliableParts = (await ComponentesDb.GetPartsByTypeAsync(PartTipo.Motherboard)), PartToAssemble = getPartByType(PartTipo.Motherboard), ETA = 5 },
                    new Steps { StepNumber = 3, Name = "Processor", Label = "Install CPU", IsCompleted = false, AvaliableParts = (await ComponentesDb.GetPartsByTypeAsync(PartTipo.Processor)), PartToAssemble = getPartByType(PartTipo.Processor), ETA = 8 },
                    new Steps { StepNumber = 4, Name = "Memory", Label = "Install RAM", IsCompleted = false, AvaliableParts = (await ComponentesDb.GetPartsByTypeAsync(PartTipo.Memory)), PartToAssemble = getPartByType(PartTipo.Memory), ETA = 7 },
                    new Steps { StepNumber = 5, Name = "Graphics Card", Label = "Install GPU", IsCompleted = false, AvaliableParts = (await ComponentesDb.GetPartsByTypeAsync(PartTipo.GraphicsCard)), PartToAssemble = getPartByType(PartTipo.GraphicsCard), ETA = 4 },
                    new Steps { StepNumber = 6, Name = "Storage", Label = "Install Storage", IsCompleted = false, AvaliableParts = (await ComponentesDb.GetPartsByTypeAsync(PartTipo.Storage)), PartToAssemble = getPartByType(PartTipo.Storage), ETA = 8 },
                    //new Steps { StepNumber = 7, Name = "Cooling", Label = "Install Cooling", IsCompleted = false, AvaliableParts = (await ComponentesDb.GetPartsByTypeAsync(PartTipo.Cooling)), PartToAssemble = getPartByType(PartTipo.Cooling), ETA = 15 },
                };
            }
        }
    }

    private async void OrderDone() {
        if (partsWithQuantities == null) {
            Console.WriteLine("No parts found to update.");
            return;
        }

        foreach (var (part, quantity) in partsWithQuantities) {
            try {
                int newQuantidade = quantity - 1;

                if (newQuantidade < 0) {
                    Console.WriteLine($"Cannot update PartId: {part.PartId}. Quantity would become negative.");
                    continue;
                }
                var updatedInventario = await InventarioDb.UpdateFirstOrDefaultAsync(part.PartId, newQuantidade);

                if (updatedInventario == null) {
                    Console.WriteLine($"Failed to update PartId: {part.PartId}");
                } else {
                    Console.WriteLine($"Updated PartId: {part.PartId}. New Quantity: {updatedInventario.Quantidade}");
                }
            } catch (Exception ex) {
                Console.WriteLine($"An error occurred while updating PartId: {part.PartId}. Error: {ex.Message}");
            }
        }

        if (order != null) {
            await OrdersDb.UpdateOrderStatusToDoneAsync(order.OrderId);
        }
        Navigation.NavigateTo("/dashboard/assembly", true);
    }
    private Part? getPartByType(PartTipo type)
    {
        if (partsWithQuantities == null) {
            return null; 
        }
        var match = partsWithQuantities.FirstOrDefault(p => p.Part.Tipo == type);
        return match.Part;
    }

    private void OnStepChange(FluentWizardStepChangeEventArgs e) {
        Console.WriteLine($"Go to step {e.TargetLabel} (#{e.TargetIndex})");
    }

    private void OnFinishedAsync() {
        Console.WriteLine("Finished wizard");
    }
    private void stepDone(int StepNumber) {
        Console.WriteLine("can advance to the next step");
        if (steps != null) {
            steps[StepNumber].IsCompleted = true;
            foreach (var step in steps) {
                Console.WriteLine($"Step '{step.Label}' is completed: {step.IsCompleted}");
                if (!step.IsCompleted) {
                    Finalize = false;
                    return;
                } else {
                    Finalize = true;
                }
            }
        }

        StateHasChanged(); // Refresh the UI
    }

    private void stepUnDone(int StepNumber) {
        Console.WriteLine("Reverting the last completed step");
        if (steps != null && StepNumber < steps.Count - 1) {
            steps[StepNumber + 1].IsCompleted = false;
            if (StepNumber == steps.Count - 1) {
                Finalize = false;
            }
        }

        StateHasChanged(); // Refresh the UI
    }

    private void stepStarted(int StepNumber) {
        /*if (steps != null && StepNumber != 0) {
            steps[StepNumber].IsCompleted = false;
            Console.WriteLine($"Step '{steps[StepNumber - 1].Label}' marked as not completed.");
        }

        StateHasChanged(); // Refresh the UI*/
    }

    private int trulyCompletedIndex() {
    if (steps == null) {
        return -1; // Return -1 if the steps list is null
    }

    for (int i = steps.Count - 1; i >= 0; i--) {
        if (steps[i].IsCompleted) {
            return i; // Return the highest index where IsCompleted is true
        }
    }

    return -1;
    }

    private bool IsStepCompleted(int stepNumber) {
        if (steps == null) {
            return false;
        }
        return steps[stepNumber].IsCompleted;
    }

    private int calculateTotalETA() {
        if (steps == null) {
            return 0;
        }
        int totalETA = 0;
        foreach (var step in steps) {
            totalETA += step.ETA;
        }
        return totalETA;
    }

    private FluentWizard? wizardInstance;

    private void jumpToStep(int stepNumber) {
        if (steps != null && wizardInstance != null) {
            wizardInstance.GoToStepAsync(stepNumber+1); // +1 to offset the overview step
        }
    }

    private string imageUrl { get; set; } = "/assets/pcbuild-step-0.png";
    private void hoveringItem(int item) {
        switch (item) {
            case 3:
                imageUrl = "/assets/pcbuild-step-1.png";
                break;
            case 7:
                imageUrl = "/assets/pcbuild-step-2.png";
                break;
            case 2:
                imageUrl = "/assets/pcbuild-step-3.png";
                break;
            case 4:
                imageUrl = "/assets/pcbuild-step-4.png";
                break;
            case 5:
                imageUrl = "/assets/pcbuild-step-5.png";
                break;
            case 6:
                imageUrl = "/assets/pcbuild-step-6.png";
                break;
            case 1:
                imageUrl = "/assets/pcbuild-step-7.png";
                break;
            case 0:
                imageUrl = "/assets/pcbuild-step-8.png";
                break;
            default:
                imageUrl = "/assets/pcbuild-step-0.png";
                break;
        }
    }
}

<style scoped>
    .h-screen-space {
        /* Calculate the height of the screen without the height of the header */
        height: calc(100vh - 12.0rem);
    }

    .h-step-screen {
        height: calc(100vh - 18.0rem);
    }
</style>