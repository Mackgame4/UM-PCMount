@page "/dashboard/inventory"
@using Microsoft.FluentUI.AspNetCore.Components
@using PCMount.Components.UI
@using Microsoft.EntityFrameworkCore
@using PCMount.Data
@using PCMount.Data.Models
@inject ApplicationDbContext DbContext
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@using PCMount.Components.Layout
@layout DashboardLayout
<PageTitle>PCMount - Inventory</PageTitle>

<div class="rounded-md py-2 mb-4 flex justify-between">
    <div class="flex gap-6 w-1/3">
        <FluentMenuButton Text="Select model"></FluentMenuButton>
    </div>
    <div class="ml-4 w-1/3 flex gap-4">
        <FluentSearch class="w-full" Placeholder="Search for Parts" Value="@searchTerm" @oninput="OnSearchInput" />
        <FluentMenuButton Text="Order by"></FluentMenuButton>
    </div>
    <div class="flex w-1/3">
    </div>
</div>

@if (filteredProducts == null)
{
    <LoadingDialog Title="Loading Inventory..." />
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-7 gap-5">
        @foreach (int element in Enumerable.Range(1, 14))
        {
            <FluentSkeleton Width="100%" Height="340px"></FluentSkeleton>
        }
    </div>
}
else
{
    @if (filteredProducts != null && !filteredProducts.Any())
    {
        <div class="text-center text-xl text-gray-200 mt-8">
            No products found.
        </div>
    }
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-7 gap-5">
        @foreach (Product product in filteredProducts!)
        {
            <div class="tr transition duration-300 ease-in-out">
                <FluentCard MinimalStyle="true" class="relative flex flex-col justify-center items-center text-center gap-2 hover:translate-y-2">
                    <FluentButton 
                        class="absolute top-2 left-2" 
                        IconStart="@(new Icons.Regular.Size16.Info())"
                        Appearance="Appearance.Lightweight"
                        @onclick="() => ShowDescription(product)">
                    </FluentButton>
                    <div class="w-36 rounded-md">
                        <img src="@product.ImageUrl" class="object-cover w-full h-full rounded-md" />
                    </div>
                    <h3 class="-mb-2">
                        @product.Name
                    </h3>
                    <span>
                        @product.Category
                    </span>
                    <FluentBadge Appearance="Appearance.Lightweight" class="font-bold">
                        #LI4
                        <span>
                            @product.StockCode
                        </span>
                    </FluentBadge>
                    <div class="flex flex-row gap-2 justify-center items-center text-center text-xl">
                        <span>
                            Price:
                        </span>
                        <FluentBadge Appearance="Appearance.Neutral" class="text-lg mt-1">
                            <span class="text-green-500">
                                @product.Priceâ‚¬
                            </span>
                        </FluentBadge>
                        <FluentSpacer />
                        <span class="text-xl">
                            Quantity:
                        </span>
                        <FluentBadge Appearance="Appearance.Neutral" class="text-lg mt-1">
                            <span class="text-green-500">
                                @product.Quantity                            
                            </span>
                        </FluentBadge>
                    </div>
                </FluentCard>
            </div>
        }
    </div>

    @if (isDialogVisible == true)
    {
        <!-- FluentDialog for displaying product description -->
        <FluentDialog>
            <DialogTitle>
                <p class="font-bold text-xl text-center relative">@selectedProduct?.Name</p>
            </DialogTitle>
            <DialogContent>
                <p class="text-justify italic">
                    @selectedProduct?.Description
                </p>
            </DialogContent>
            <DialogActions class=" absolute flex items-center justify-center top-5 right-5">
                <FluentButton class="font-bold text-lg text-gray-300" @onclick="() => CloseDescription()">
                    x
                </FluentButton>
            </DialogActions>
        </FluentDialog>
    }
}

@code {
    private List<Product>? products;
    private bool isDialogVisible = false;
    private List<Product>? filteredProducts; // Filtered list of products
    private Product? selectedProduct;
    private List<Inventario>? inventoryItems;

    private string searchTerm = string.Empty; // Search term

    protected override async Task OnInitializedAsync()
    {
         await Task.Delay(500);
        // Query the database to fetch Inventario data
        inventoryItems = await DbContext.Inventario
            .Include(i => i.Part) // Include the related Part data
            .ToListAsync();

        // Map Inventario data to the Product model
        products = inventoryItems.Select(i => new Product
        {
            Name = i.Part!.Name,
            Category = i.Part.Tipo, // Assuming "Type" maps to "Category"
            StockCode = i.Part.PartId.ToString(), // Use PartId as StockCode
            Price = (decimal)i.Part.Preco, // Convert float to decimal
            Quantity = i.Quantidade,
            Description = i.Part.Descricao!,
            ImageUrl = i.Part.Image!
        }).ToList();

        // Initialize filteredProducts with all products
        filteredProducts = products;
    }

    private void ShowDescription(Product product)
    {
        selectedProduct = product;
        isDialogVisible = true;
    }

    private void CloseDescription()
    {
        isDialogVisible = false;
    }

    private void FilterProducts()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            // If the search term is empty, show all products
            filteredProducts = products;
        }
        else
        {
            // Filter products whose names contain the search term (case-insensitive)
            filteredProducts = products?
                .Where(p => p.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        // Explicitly tell Blazor to re-render the UI
        StateHasChanged();
    }
    // This method is called whenever the user types in the search box
    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty; // Update the search term
        FilterProducts(); // Filter the products
    }

    public class Product
    {
        public required string Name { get; set; }
        public required string Category { get; set; }
        public required string StockCode { get; set; }
        public required decimal Price { get; set; }
        public required int Quantity { get; set; }
        public required string Description { get; set; }
        public required string ImageUrl { get; set; }
    }
}

<style scoped>
.tr:hover {
  transform: scale(1.05); 
}
</style>
