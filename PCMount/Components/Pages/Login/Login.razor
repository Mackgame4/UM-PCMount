@page "/login"

@using PCMount.Data.Models

@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.FluentUI.AspNetCore.Components
@inject NavigationManager NavigationManager
@using Microsoft.EntityFrameworkCore
@using PCMount.Data
@inject ApplicationDbContext DbContext

<FluentDialog>
    <FluentDialogHeader Visible="false" />
    <FluentDialogBody Class="flex flex-col items-center justify-center space-y-4 p-8">
        <img src="assets/pcmountlogo.png" alt="PCMount Logo" class="w-32 h-32 mx-auto" />
        <EditForm Model="@LoginModel" OnValidSubmit="Authenticate" FormName="LoginForm">
            <DataAnnotationsValidator />
            <div class="flex flex-col items-center text-center justify-center space-y-2">
                <b>Username</b>
                <div>
                    <InputText @bind-Value="@LoginModel.UserName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" placeholder="Username" />
                    <ValidationMessage style="color: red;" For="() => LoginModel.UserName" />
                </div>
                <b>Password</b>
                <div>
                    <InputText @bind-Value="@LoginModel.Password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" placeholder="Password" type="password" />
                    <ValidationMessage style="color: red;" For="() => LoginModel.Password" />
                </div>
                <span style="color: red;">@errorMessage</span>
                <FluentButton IconStart="@(new Icons.Regular.Size16.Key())" Type="ButtonType.Submit" Appearance="Appearance.Accent">Login</FluentButton>
            </div>
        </EditForm>
    </FluentDialogBody>
    <FluentDialogFooter Visible="false" />
</FluentDialog>

@code{
    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }

    [SupplyParameterFromForm]
    private LoginViewModel LoginModel { get; set; } = new ();

    private string? errorMessage;

    private async Task Authenticate() {
        bool redirect = false;
        try {
            List<User> usersAccounts = await DbContext.Users.ToListAsync();
            if (usersAccounts == null || !usersAccounts.Any()) {
                errorMessage = "No users found.";
                return;
            }
            if (string.IsNullOrWhiteSpace(LoginModel.UserName) || string.IsNullOrWhiteSpace(LoginModel.Password)) {
                errorMessage = "Username and Password are required.";
                return;
            }
            var userAccount = usersAccounts.FirstOrDefault(u => u.UserName == LoginModel.UserName);
            if (userAccount is null || userAccount.Password != LoginModel.Password) {
                errorMessage = "Invalid Username or Password.";
                return;
            }

            var claims = new List<Claim> {
                new Claim(ClaimTypes.Name, userAccount.UserName!),
                new Claim(ClaimTypes.Role, userAccount.Role!)
            };

            var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
            var principal = new ClaimsPrincipal(identity);
            await HttpContext!.SignInAsync(principal);
            redirect = true;
        } catch (Exception ex) {
            errorMessage = $"Authentication failed: {ex.Message}";
        } finally {
            if (redirect) {
                NavigationManager.NavigateTo("/", true);
            }
        }
    }
}