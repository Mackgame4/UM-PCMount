@namespace PCMount.Components.UI
@using Microsoft.FluentUI.AspNetCore.Components
@using PCMount.Data.Models
@using Microsoft.EntityFrameworkCore
@using PCMount.Data
@inject ApplicationDbContext DbContext
@implements IDialogContentComponent<Computer>

<FluentDialogHeader ShowDismiss="true">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentIcon Value="@(new Icons.Regular.Size24.WindowApps())" />
        <FluentLabel Typo="Typography.PaneHeader">
            @Dialog!.Instance.Parameters.Title
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>
<FluentDialogBody>
    <FluentStack VerticalAlignment="VerticalAlignment.Center" Orientation="Orientation.Vertical" Gap="GapSize.Small">
        <FluentAutocomplete TOption="Part" AutoComplete="off" Label="Motherboard" OnOptionsSearch="@(e => OnSearch(e, "Motherboard"))" Placeholder="Select Motherboard" MaximumOptionsSearch="int.MaxValue" MaximumSelectedOptions="1" OptionText="@(item => item.Name)" @bind-SelectedOptions="SelectedMotherboards" />
        <FluentAutocomplete TOption="Part" AutoComplete="off" Label="Processor" OnOptionsSearch="@(e => OnSearch(e, "Processor"))" Placeholder="Select Processor" MaximumOptionsSearch="int.MaxValue" MaximumSelectedOptions="1" OptionText="@(item => item.Name)" @bind-SelectedOptions="SelectedProcessors" />
        <FluentAutocomplete TOption="Part" AutoComplete="off" Label="Memory" OnOptionsSearch="@(e => OnSearch(e, "Memory"))" Placeholder="Select Memory" MaximumOptionsSearch="int.MaxValue" MaximumSelectedOptions="1" OptionText="@(item => item.Name)" @bind-SelectedOptions="SelectedMemories" />
        <FluentAutocomplete TOption="Part" AutoComplete="off" Label="Graphics Card" OnOptionsSearch="@(e => OnSearch(e, "GraphicsCard"))" Placeholder="Select Graphics Card" MaximumOptionsSearch="int.MaxValue" MaximumSelectedOptions="1" OptionText="@(item => item.Name)" @bind-SelectedOptions="SelectedGraphicsCards" />
        <FluentAutocomplete TOption="Part" AutoComplete="off" Label="Storage" OnOptionsSearch="@(e => OnSearch(e, "Storage"))" Placeholder="Select Storage" MaximumOptionsSearch="int.MaxValue" MaximumSelectedOptions="1" OptionText="@(item => item.Name)" @bind-SelectedOptions="SelectedStorages" />
        <FluentAutocomplete TOption="Part" AutoComplete="off" Label="Power Supply" OnOptionsSearch="@(e => OnSearch(e, "PowerSupply"))" Placeholder="Select Power Supply" MaximumOptionsSearch="int.MaxValue" MaximumSelectedOptions="1" OptionText="@(item => item.Name)" @bind-SelectedOptions="SelectedPowerSupplies" />
        <FluentAutocomplete TOption="Part" AutoComplete="off" Label="Case" OnOptionsSearch="@(e => OnSearch(e, "Case"))" Placeholder="Select Case" MaximumOptionsSearch="int.MaxValue" MaximumSelectedOptions="1" OptionText="@(item => item.Name)" @bind-SelectedOptions="SelectedCases" />
    </FluentStack>
</FluentDialogBody>
<FluentDialogFooter>
    <FluentButton IconStart="@(new Icons.Regular.Size16.Cart())" Appearance="Appearance.Accent" OnClick="@SaveAsync">Add To Cart</FluentButton>
    <FluentButton Appearance="Appearance.Neutral" OnClick="@CancelAsync">Cancel</FluentButton>
</FluentDialogFooter>

@code {
    [Parameter]
    public Computer Content { get; set; } = new Computer { Name = "Custom Build", Price = 0, Image = "/assets/cdn/computer-custom-build.png" };

    [CascadingParameter]
    public FluentDialog? Dialog { get; set; }

    IEnumerable<Part> SelectedMotherboards = Array.Empty<Part>();
    private Part? SelectedMotherboard;
    IEnumerable<Part> SelectedProcessors = Array.Empty<Part>();
    private Part? SelectedProcessor;
    IEnumerable<Part> SelectedMemories = Array.Empty<Part>();
    private Part? SelectedMemory;
    IEnumerable<Part> SelectedGraphicsCards = Array.Empty<Part>();
    private Part? SelectedGraphicsCard;
    IEnumerable<Part> SelectedStorages = Array.Empty<Part>();
    private Part? SelectedStorage;
    IEnumerable<Part> SelectedPowerSupplies = Array.Empty<Part>();
    private Part? SelectedPowerSupply;
    IEnumerable<Part> SelectedCases = Array.Empty<Part>();
    private Part? SelectedCase;

    Part[] Components = Array.Empty<Part>();

    protected override async Task OnInitializedAsync() {
        Components = await DbContext.Componentes.ToArrayAsync();
        SelectedMotherboard = SelectedMotherboards.FirstOrDefault();
        SelectedProcessor = SelectedProcessors.FirstOrDefault();
        SelectedMemory = SelectedMemories.FirstOrDefault();
        SelectedGraphicsCard = SelectedGraphicsCards.FirstOrDefault();
        SelectedStorage = SelectedStorages.FirstOrDefault();
        SelectedPowerSupply = SelectedPowerSupplies.FirstOrDefault();
        SelectedCase = SelectedCases.FirstOrDefault();
    }

    private void OnSearch(OptionsSearchEventArgs<Part> e, string partType) {
        e.Items = Components.Where(part => part.Tipo.ToString() == partType && part.Name.Contains(e.Text, StringComparison.OrdinalIgnoreCase));
    }

    private double calculatePrice() {
        double price = 0;
        price += SelectedMotherboard?.Preco ?? 0;
        price += SelectedProcessor?.Preco ?? 0;
        price += SelectedMemory?.Preco ?? 0;
        price += SelectedGraphicsCard?.Preco ?? 0;
        price += SelectedStorage?.Preco ?? 0;
        price += SelectedPowerSupply?.Preco ?? 0;
        price += SelectedCase?.Preco ?? 0;
        return price;
    }

    private async Task SaveAsync() {
        Content = new Computer { Name = "Custom Build", Price = calculatePrice(), Image = "/assets/cdn/computer-custom-build.png", Motherboard = SelectedMotherboard!, Processor = SelectedProcessor!, Memory = SelectedMemory!, GraphicsCard = SelectedGraphicsCard!, Storage = SelectedStorage!, PowerSupply = SelectedPowerSupply!, Case = SelectedCase! };
        Console.WriteLine($"Motherboard: {Content.Motherboard?.Name}");
        Console.WriteLine($"Processor: {Content.Processor?.Name}");
        Console.WriteLine($"Memory: {Content.Memory?.Name}");
        Console.WriteLine($"Graphics Card: {Content.GraphicsCard?.Name}");
        Console.WriteLine($"Storage: {Content.Storage?.Name}");
        Console.WriteLine($"Power Supply: {Content.PowerSupply?.Name}");
        Console.WriteLine($"Case: {Content.Case?.Name}");
        Console.WriteLine($"Price: {Content.Price}");
        await Dialog!.CloseAsync(Content);
    }

    private async Task CancelAsync() {
        await Dialog!.CancelAsync();
    }
}