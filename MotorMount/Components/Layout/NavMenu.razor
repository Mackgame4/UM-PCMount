@using Microsoft.FluentUI.AspNetCore.Components
@rendermode InteractiveServer
@inject NavigationManager Navigation

<div class="flex flex-col relative w-full">
    <FluentStack Orientation="Orientation.Horizontal" Width="100%" class="p-4">
        <NavLink href="" Match="NavLinkMatch.All" ><img src="/assets/motormountlogo.png" Slot="start" width="30px"/></NavLink>
        <NavLink class="w-full" href="" Match="NavLinkMatch.All">
            <FluentButton class="hidden sm:inline-flex" Appearance="Appearance.Accent">
                <span>MotorMount @(CurrentPageTitle != null ? "- " + CurrentPageTitle : "")</span>
            </FluentButton>
        </NavLink>
        <FluentSpacer />
        <FluentButton id="themePopover" IconStart="@(new Icons.Regular.Size20.PaintBrush())" Appearance="Appearance.Outline" @onclick="() => _visibleThemePopover = !_visibleThemePopover"></FluentButton>
        <FluentCounterBadge Dot="true" Appearance="Appearance.Accent">
            <FluentButton IconStart="@(new Icons.Regular.Size16.Alert())" Appearance="Appearance.Outline"></FluentButton>
        </FluentCounterBadge>
        <FluentProfileMenu Initials="LI4">
            <HeaderTemplate>
                <FluentLabel Typo="@Typography.Header">Welcome,</FluentLabel>
            </HeaderTemplate>
            <ChildContent>
                <div style="width: 250px; height: 80px">
                    <FluentLabel Typo="@Typography.Header" Style="font-weight: bold;">User</FluentLabel>
                    <FluentLabel>user@outlook.com</FluentLabel>
                </div>
            </ChildContent>
            <FooterTemplate>
                <FluentStack>
                    <FluentSpacer />
                    <span>This feature is still in development.</span>
                </FluentStack>
            </FooterTemplate>
        </FluentProfileMenu>
    </FluentStack>
    <FluentDivider Style="width: 100%;" Role="DividerRole.Presentation"></FluentDivider>
    <div class="p-3">
        @RenderMenuOptions
    </div>
    <FluentDivider Style="width: 100%;" Role="DividerRole.Presentation"></FluentDivider>
</div>

<FluentDesignTheme StorageName="theme" @bind-Mode="@Mode" @bind-OfficeColor="@OfficeColor" />
<FluentPopover class="rounded-md w-80" VerticalThreshold="170" AnchorId="themePopover" @bind-Open="_visibleThemePopover">
    <Header>@(new Emojis.Objects.Color.Default.Paintbrush().ToMarkup("20px")) Customize your experience</Header>
    <Body>
        <FluentGrid>
            <FluentGridItem>
                <FluentSelect class="w-full" Label="Theme" Items="@(Enum.GetValues<DesignThemeModes>())" Width="250px" @bind-SelectedOption="@Mode" />
            </FluentGridItem>
            <FluentGridItem>
                <FluentSelect class="w-full" Label="Color" Items="@(Enum.GetValues<OfficeColor>().Select(i => (OfficeColor?)i))" Height="200px" Width="250px" @bind-SelectedOption="@OfficeColor">
                    <OptionTemplate>
                        <FluentStack>
                            <FluentLabel>@context</FluentLabel>  
                        </FluentStack>
                    </OptionTemplate> 
                </FluentSelect>
            </FluentGridItem>
        </FluentGrid>
    </Body>
</FluentPopover>

@code {
    bool _visibleThemePopover;
    public DesignThemeModes Mode { get; set; }
    public OfficeColor? OfficeColor { get; set; }

    public class PageMetadata
    {
        public required string Path { get; set; }
        public required string Title { get; set; }
        public required Microsoft.FluentUI.AspNetCore.Components.Icon Icon { get; set; }
    }

    private List<PageMetadata> pagesmetadata = new List<PageMetadata>
    {
        new PageMetadata { Path = "/", Title = "Dashboard", Icon = new Icons.Regular.Size20.Home() },
        new PageMetadata { Path = "/shop", Title = "Parts Shop", Icon = new Icons.Regular.Size20.Cart() },
        new PageMetadata { Path = "/inventory", Title = "Inventory", Icon = new Icons.Regular.Size20.Box() },
        new PageMetadata { Path = "/assembly", Title = "Assembly", Icon = new Icons.Regular.Size20.Wrench() }
    };

    private RenderFragment RenderMenuOptions => @<FluentStack Orientation="Orientation.Horizontal" Width="100%">
        @foreach (var pagemetadata in pagesmetadata)
        {
            <NavLink class="w-full" href="@pagemetadata.Path" Match="NavLinkMatch.All">
                <FluentButton class="w-full hidden sm:inline-flex" IconStart="@pagemetadata.Icon" Appearance="Appearance.Lightweight">@pagemetadata.Title</FluentButton>
                <FluentButton class="w-full inline-flex sm:hidden" IconStart="@pagemetadata.Icon" Appearance="Appearance.Lightweight"></FluentButton>
            </NavLink>
        }
    </FluentStack>;

    private string? CurrentPageTitle { get; set; }

    protected override void OnInitialized() // When component is loaded
    {
        base.OnInitialized();
        SetPageTitle();
        Navigation.LocationChanged += (sender, args) => SetPageTitle();  // Listen for navigation changes
    }

    private void SetPageTitle() {
        var uri = Navigation.Uri;
        var page = pagesmetadata.FirstOrDefault(p => uri.EndsWith(p.Path));
        CurrentPageTitle = page?.Title ?? pagesmetadata[0].Title; // Default to "Dashboard" if no match found
        StateHasChanged(); // Trigger UI update
    }
}